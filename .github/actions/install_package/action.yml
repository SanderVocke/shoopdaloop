# Install a package

inputs:
  package:
    description: "package file / directory"
  coverage:
    description: "Whether to gather code coverage"
  sudo:
    description: "whether sudo is needed to install software"
    default: 'false'

runs:
  using: "composite"
  steps:

  - name: Determine package kind
    if: always()
    shell: wrap-shell {0}
    id: get_type
    run: |
       filename=${{ inputs.package }}
       if [[ $filename == *linux*.portable.tar.gz ]]; then
           type="portable-linux"
       elif [[ $filename == *macos*.portable.tar.gz ]]; then
           type="portable-macos"
       elif [[ $filename == *windows*.portable.tar.gz ]]; then
           type="portable-windows"
       else
         type="${filename##*.}"
       fi
       echo "type=$type" | tee -a $GITHUB_OUTPUT

  - name: Sudo command
    if: always()
    shell: wrap-shell {0}
    run: |
       echo "maybe_sudo=${{ (inputs.sudo == 'true') && 'sudo' || '' }}" | tee -a $GITHUB_ENV

  # InnoSetup
  - name: Install InnoSetup installer
    if: always() && steps.get_type.outputs.type == 'exe'
    shell: wrap-shell {0}
    run: |
      WINDOWS_SETUP_PATH=$(cygpath -w $(realpath ${{ inputs.package }}))
      INSTALL_CMD="$WINDOWS_SETUP_PATH /VERYSILENT /CURRENTUSER /DIR=\"$(cygpath -w $(pwd)/installed)\""
      echo "PowerShell installation command: $INSTALL_CMD"
      powershell -Command "echo \"Run in powershell: $INSTALL_CMD\" ; $INSTALL_CMD"
      SHOOPDALOOP_EXE=$(pwd)/installed/shoopdaloop.exe
      SHOOPDALOOP_DIR=$(dirname "$SHOOPDALOOP_EXE")
      echo "ShoopDaLoop executable installed to: $SHOOPDALOOP_EXE"
      echo "Installed at: $SHOOPDALOOP_DIR"
      echo "cmd=\\\"$SHOOPDALOOP_EXE\\\"" | tee -a $GITHUB_ENV
      echo "install_dir=\\\"$SHOOPDALOOP_DIR\\\"" | tee -a $GITHUB_ENV

  # Linux portable folder
  - name: Setup Linux AppDir portable folder
    if: always() && steps.get_type.outputs.type == 'portable-linux'
    shell: wrap-shell {0}
    run: |
      mkdir portable
      cd portable
      tar -xzf ${{ inputs.package }}
      cd ..
      PORTABLE=$(pwd)/portable/*
      echo "COMMAND_SHOOPDALOOP=$PORTABLE/shoopdaloop" | tee -a $GITHUB_ENV
      echo "COMMAND_TEST_BACKEND=$PORTABLE/backend_tests" | tee -a $GITHUB_ENV
      echo "COMMAND_TEST_RUST=$PORTABLE/rust_tests" | tee -a $GITHUB_ENV
      echo "COMMAND_TEST_PYTHON=$PORTABLE/python_tests" | tee -a $GITHUB_ENV
  
  # Windows portable folder
  - name: Setup Windows portable folder
    if: always() && steps.get_type.outputs.type == 'portable-windows'
    shell: wrap-shell {0}
    run: |
      mkdir portable
      cd portable
      tar -xzf ${{ inputs.package }}
      cd ..
      PORTABLE=$(pwd)/portable/*
      echo "COMMAND_SHOOPDALOOP=$PORTABLE/shoopdaloop" | tee -a $GITHUB_ENV
  
  # MacOS portable folder
  - name: Setup MacOS app bundle folder
    if: always() && steps.get_type.outputs.type == 'portable-macos'
    shell: wrap-shell {0}
    run: |
      mkdir portable
      cd portable
      tar -xzf ${{ inputs.package }}
      cd ..
      PORTABLE=$(pwd)/portable/*
      echo "COMMAND_SHOOPDALOOP=$PORTABLE/Contents/MacOS/shoopdaloop" | tee -a $GITHUB_ENV

  # Linux AppImage
  - name: Setup AppImage
    if: always() && steps.get_type.outputs.type == 'AppImage'
    shell: wrap-shell {0}
    run: |
      chmod a+x ${{ inputs.package }}
      echo "COMMAND_SHOOPDALOOP=${{ inputs.package }} --appimage-extract-and-run" | tee -a $GITHUB_ENV
      # echo "COMMAND_TEST_BACKEND=SHOOPDALOOP_APPIMAGE_EXECUTE=backend_tests ${{ inputs.package }} --appimage-extract-and-run" | tee -a $GITHUB_ENV
      # echo "COMMAND_TEST_RUST=SHOOPDALOOP_APPIMAGE_EXECUTE=rust_tests ${{ inputs.package }} --appimage-extract-and-run" | tee -a $GITHUB_ENV
      # echo "COMMAND_TEST_PYTHON=SHOOPDALOOP_APPIMAGE_EXECUTE=python_tests ${{ inputs.package }} --appimage-extract-and-run" | tee -a $GITHUB_ENV

  # MacOS .dmg installer
  - name: Install MacOS .dmg
    if: always() && steps.get_type.outputs.type == 'dmg'
    shell: wrap-shell {0}
    run: |
      hdiutil attach ${{ inputs.package }}
      echo "cmd=/Volumes/ShoopDaLoop/shoopdaloop.app/Contents/MacOS/shoopdaloop" | tee -a $GITHUB_ENV
      echo "install_dir=/Volumes/ShoopDaLoop/shoopdaloop.app/Contents/MacOS" | tee -a $GITHUB_ENV

