# Build a meson project and upload it

inputs:
  name:
    description: "name of the dependency"
  repo:
    description: "repository URL"
  git_rev:
    description: "git revision to build"
  meson_options:
    description: "additional meson configure options"

runs:
  using: "composite"
  steps:

  - shell: wrap-shell {0}
    run: |
       echo "============= ENV ==================="
       env
       echo "================ END ENV ============"
       cat $GITHUB_ENV
       echo "===========END GHA==========="
       git clone ${{ inputs.repo }} ${{ inputs.name }}
       cd ${{ inputs.name }}
       git checkout ${{ inputs.git_rev }}
       mkdir ${{ inputs.name }}
       mkdir build
       ${{ env.MESON }} setup --prefix=$(pwd)/${{ inputs.name }} --pkgconfig.relocatable build .
       cd build
       ${{ env.MESON }} compile
       ${{ env.MESON }} install
       cd ..
       PKGCONFIG_DIR=$(find $(pwd)/${{ inputs.name }} -name pkgconfig)
       echo "Pkg config dir in install folder: $PKGCONFIG_DIR"
       PKG_CONFIG_PATH=${{ env.PKG_CONFIG_PATH }} ${{ env.ADD_PKG_CONFIG_PATH }} $PKGCONFIG_DIR

  - name: Upload
    uses: actions/upload-artifact@v4
    with:
      name: ${{ inputs.name }}
      path: ${{ github.workspace }}/${{ inputs.name }}/${{ inputs.name }}

