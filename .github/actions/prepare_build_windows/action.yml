name: prepare_build_windows
description: Prepare Windows for building Shoopdaloop wheels

outputs:
  qt_install_dir:
    description: Place where Qt was installed
    value: ${{ steps.install_qt.outputs.install_dir }}

runs:
  using: "composite"
  steps:
  - uses: actions/setup-python@v4
    with:
      python-version: '3.8' 
  - name: Report python version
    shell: bash
    run: |
      echo "Default python version is $(python --version)"
  - name: Install Qt
    uses: ./.github/actions/install_qt
    id: install_qt
    with:
      url: https://github.com/SanderVocke/shoopdaloop/releases/download/qt-6.6.0-1/qt-6.6.0-windows.tar.gz
  - name: Install boost
    id: install_boost
    uses: ./.github/actions/install_boost_headers
    with:
      dir: includes
  - name: Install pkgconfig lite
    shell: bash
    run: |
      curl -L https://github.com/SanderVocke/shoopdaloop/releases/download/qt-6.6.0-1/pkg-config-lite-0.28-1_bin-win32.zip --output pkg-config-lite-0.28-1_bin-win32.zip
      unzip pkg-config-lite-0.28-1_bin-win32.zip
      cp pkg-config-lite-0.28-1/bin/* /c/mingw64/bin
  - name: Path conversion
    id: pathconvert
    shell: bash
    run: |
      echo "include_dir=$(cygpath -w ${{ steps.install_boost.outputs.include_dir }})" | tee -a $GITHUB_OUTPUT
  - name: Install dependencies and provide build command prefix
    shell: bash
    run: |
      python -m pip install build virtualenv pytest meson
      echo "set \"CMAKE_INCLUDE_PATH=${{ steps.pathconvert.outputs.include_dir }}\" && set \"CMAKE_PREFIX_PATH=${{ steps.install_qt.outputs.install_dir }}/lib/cmake/Qt6\" &&" > prepend_build_cmd.txt
